<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bookbinder MVP</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <main class="page">
      <h1>Bookbinder MVP</h1>
      <p class="subtitle">Folio-only PDF imposition</p>

      <form class="panel" action="/impose" method="post" enctype="multipart/form-data">
        <label for="file">Source PDF</label>
        <input id="file" name="file" type="file" accept="application/pdf,.pdf" required />

        <label for="paper_size">Paper size</label>
        <select id="paper_size" name="paper_size">
          {% for size in paper_sizes %}
          <option value="{{ size }}" {{ "selected" if form.paper_size == size else "" }}>{{ size }}</option>
          {% endfor %}
        </select>
        <p class="hint">Choose "Custom" to provide width and height in millimeters.</p>

        <label for="custom_width_mm">Custom width (mm)</label>
        <input id="custom_width_mm" name="custom_width_mm" type="number" min="0.1" step="any" value="{{ form.custom_width_mm }}" />

        <label for="custom_height_mm">Custom height (mm)</label>
        <input id="custom_height_mm" name="custom_height_mm" type="number" min="0.1" step="any" value="{{ form.custom_height_mm }}" />

        <label for="scaling_mode">Scaling mode</label>
        <select id="scaling_mode" name="scaling_mode">
          {% for mode in scaling_modes %}
          <option value="{{ mode }}" {{ "selected" if form.scaling_mode == mode else "" }}>{{ mode }}</option>
          {% endfor %}
        </select>

        <label for="signature_length">Signature length (sheets)</label>
        <input id="signature_length" name="signature_length" type="number" min="1" value="{{ form.signature_length }}" required />

        <label for="flyleafs">Flyleaf sets</label>
        <input id="flyleafs" name="flyleafs" type="number" min="0" value="{{ form.flyleafs }}" required />

        <label class="checkbox" for="duplex_rotate">
          <input id="duplex_rotate" name="duplex_rotate" type="checkbox" value="true" {{ "checked" if form.duplex_rotate else "" }} />
          Duplex rotate
        </label>

        <div class="actions">
          <button type="submit" name="action" value="generate">Generate</button>
          <button type="submit" name="action" value="preview">Preview first sheet</button>
        </div>
      </form>

      {% if result %}
      <section class="panel result result-{{ result.status }}">
        <h2>{{ result.status | capitalize }}</h2>
        <p>{{ result.message }}</p>
        {% if result.status == "success" and "output_pages" in result %}
        <p>Output pages: {{ result.output_pages }}</p>
        <a href="{{ result.download_url }}" download>Download {{ result.output_filename }}</a>
        {% endif %}
        {% if result.status == "success" and "preview_pages" in result %}
        <p>Preview pages: {{ result.preview_pages }}</p>
        <a href="{{ result.preview_url }}" download>Download {{ result.preview_filename }}</a>
        {% endif %}
      </section>
      {% endif %}
    </main>
    <script>
      (function () {
        const storageKey = "bookbinder.form.v1";
        const form = document.querySelector('form[action="/impose"]');
        if (!form || typeof window.localStorage === "undefined") {
          return;
        }

        const persistable = Array.from(form.elements)
          .filter((element) => {
            return (
              element instanceof HTMLInputElement ||
              element instanceof HTMLSelectElement ||
              element instanceof HTMLTextAreaElement
            );
          })
          .filter((element) => {
            return element.name && element.type !== "file" && element.type !== "submit" && element.type !== "button";
          });

        const saveSettings = function () {
          const snapshot = {};
          for (const element of persistable) {
            if (element instanceof HTMLInputElement && element.type === "checkbox") {
              snapshot[element.name] = element.checked;
            } else if (element instanceof HTMLInputElement && element.type === "radio") {
              if (element.checked) {
                snapshot[element.name] = element.value;
              }
            } else {
              snapshot[element.name] = element.value;
            }
          }
          window.localStorage.setItem(storageKey, JSON.stringify(snapshot));
        };

        const raw = window.localStorage.getItem(storageKey);
        if (raw) {
          try {
            const saved = JSON.parse(raw);
            if (saved && typeof saved === "object") {
              for (const element of persistable) {
                if (!Object.prototype.hasOwnProperty.call(saved, element.name)) {
                  continue;
                }
                const value = saved[element.name];
                if (element instanceof HTMLInputElement && element.type === "checkbox") {
                  element.checked = value === true;
                } else if (element instanceof HTMLInputElement && element.type === "radio") {
                  element.checked = String(value) === element.value;
                } else {
                  element.value = String(value);
                }
              }
            }
          } catch (error) {
            window.localStorage.removeItem(storageKey);
          }
        }

        form.addEventListener("input", saveSettings);
        form.addEventListener("change", saveSettings);
      })();
    </script>
  </body>
</html>
